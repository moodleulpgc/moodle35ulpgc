{"version":3,"sources":["../src/ui_ace.js"],"names":["define","$","AceWrapper","textareaId","w","h","params","textarea","document","getElementById","focused","activeElement","lang","session","window","ace","require","modelist","enabled","contents_changed","capturingTab","clickInProgress","editNode","css","resize","height","width","editor","edit","get","prop","setReadOnly","setOptions","enableBasicAutocompletion","newLineMode","$blockScrolling","getSession","setValue","val","setLanguage","setEventHandlers","captureTab","addClass","hide","focus","navigateFileEnd","aceLabel","attr","aceTextarea","fail","err","prototype","failed","failMessage","sync","language","mode","findMode","setMode","getElement","commands","bindKeys","releaseTab","t","on","getValue","trigger","container","addEventListener","e","which","keyCode","ctrlKey","altKey","preventDefault","shiftKey","destroy","isFocused","remove","selectionStart","value","length","hasFocus","candidate","filename","result","candidates","nameMap","toLowerCase","replace","i","modesByName","getModeForPath","name","outerHeight","outerWidth","Constructor"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript to interface to the Ace editor, which is used both in\n * the author editing page and by the student question submission page.\n * The class defined in this module is a plugin for the InterfaceWrapper class\n * declared in userinterfacewrapper.js. See that file for an explanation of\n * the interface to this module.\n *\n * A special case behaviour of the AceWrapper is that it needs to know\n * the Programming language that is being edited. This MUST be provided in\n * the constructor templateParams parameter (an associative array) as a string\n * with key 'lang'.\n *\n * @package    qtype\n * @subpackage coderunner\n * @copyright  Richard Lobb, 2015, 2017, The University of Canterbury\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// Thanks to Ulrich Dangel for the initial implementation of Ace within\n// CodeRunner.\n\n// WARNING: The ace editor must have already been loaded before this\n// module is used, as it assumes window.ace exists.\n\ndefine(['jquery'], function($) {\n\n    function AceWrapper(textareaId, w, h, params) {\n        // Constructor for the Ace interface object\n\n        var textarea = $(document.getElementById(textareaId)),\n            focused = textarea[0] === document.activeElement,\n            lang = params.lang,\n            session;\n\n        try {\n            window.ace.require(\"ace/ext/language_tools\");\n            this.modelist = window.ace.require('ace/ext/modelist');\n\n            this.textarea = textarea;\n            this.enabled = false;\n            this.contents_changed = false;\n            this.capturingTab = false;\n            this.clickInProgress = false;\n\n\n            this.editNode = $(\"<div></div>\"); // Ace editor manages this\n            this.editNode.css({\n                resize: 'none',\n                height: h,\n                width: \"100%\"\n            });\n\n            this.editor = window.ace.edit(this.editNode.get(0));\n            if (textarea.prop('readonly')) {\n                this.editor.setReadOnly(true);\n            }\n\n            this.editor.setOptions({\n                enableBasicAutocompletion: true,\n                newLineMode: \"unix\",\n            });\n            this.editor.$blockScrolling = Infinity;\n\n            session = this.editor.getSession();\n            session.setValue(this.textarea.val());\n\n            this.setLanguage(lang);\n\n            this.setEventHandlers(textarea);\n            this.captureTab();\n\n            // Try to tell Moodle about parts of the editor with z-index.\n            // It is hard to be sure if this is complete. ACE adds all its CSS using JavaScript.\n            // Here, we just deal with things that are known to cause a problem.\n            $('.ace_gutter').addClass('moodle-has-zindex');\n\n            textarea.hide();\n            if (focused) {\n                this.editor.focus();\n                this.editor.navigateFileEnd();\n                /*\n                var session = this.editor.getSession(),\n                    lines = session.getLength();\n                this.editor.gotoLine(lines, session.getLine(lines - 1).length);\n                */\n            }\n            this.aceLabel = $('.answerprompt');\n            this.aceLabel.attr('for', 'ace_' + textareaId);\n\n            this.aceTextarea = $('.ace_text-input');\n            this.aceTextarea.attr('id', 'ace_' + textareaId);\n            this.fail = false;\n        }\n        catch(err) {\n            // Something ugly happened. Probably ace editor hasn't been loaded\n            this.fail = true;\n        }\n    }\n\n\n    AceWrapper.prototype.failed = function() {\n        return this.fail;\n    };\n\n    AceWrapper.prototype.failMessage = function() {\n        return 'ace_ui_notready';\n    };\n\n\n    // Sync to TextArea\n    AceWrapper.prototype.sync = function() {\n        // Nothing to do ... always sync'd\n    };\n\n\n    AceWrapper.prototype.setLanguage = function(language) {\n        var session = this.editor.getSession(),\n            mode = this.findMode(language);\n        if (mode) {\n            session.setMode(mode.mode);\n        }\n    };\n\n    AceWrapper.prototype.getElement = function() {\n        return this.editNode;\n    };\n\n    AceWrapper.prototype.captureTab = function () {\n        this.capturingTab = true;\n        this.editor.commands.bindKeys({'Tab': 'indent', 'Shift-Tab': 'outdent'});\n    };\n\n    AceWrapper.prototype.releaseTab = function () {\n        this.capturingTab = false;\n        this.editor.commands.bindKeys({'Tab': null, 'Shift-Tab': null});\n    };\n\n    AceWrapper.prototype.setEventHandlers = function () {\n        var TAB = 9,\n            ESC = 27,\n            KEY_M = 77,\n            t = this;\n\n        this.editor.getSession().on('change', function() {\n            t.textarea.val(t.editor.getSession().getValue());\n            t.contents_changed = true;\n        });\n\n        this.editor.on('blur', function() {\n            if (t.contents_changed) {\n                t.textarea.trigger('change');\n            }\n        });\n\n        this.editor.on('mousedown', function() {\n            // Event order seems to be (\\ is where the mouse button is pressed, / released):\n            // Chrome: \\ mousedown, mouseup, focusin / click.\n            // Firefox/IE: \\ mousedown, focusin / mouseup, click.\n            t.clickInProgress = true;\n        });\n\n        this.editor.on('focus', function() {\n            if (t.clickInProgress) {\n                t.captureTab();\n            } else {\n                t.releaseTab();\n            }\n        });\n\n        this.editor.on('click', function() {\n            t.clickInProgress = false;\n        });\n\n        this.editor.container.addEventListener('keydown', function(e) {\n            if (e.which === undefined || e.which !== 0) { // Normal keypress?\n                if (e.keyCode === KEY_M && e.ctrlKey && !e.altKey) {\n                    if (t.capturingTab) {\n                        t.releaseTab();\n                    } else {\n                        t.captureTab();\n                    }\n                    e.preventDefault(); // Firefox uses this for mute audio in current browser tab.\n                }\n                else if (e.keyCode === ESC) {\n                    t.releaseTab();\n                }\n                else if (!(e.shiftKey || e.ctrlKey || e.altKey || e.keyCode == TAB)) {\n                    t.captureTab();\n                }\n            }\n        }, true);\n    };\n\n    AceWrapper.prototype.destroy = function () {\n        var focused;\n        if (!this.fail) {\n            // Proceed only if this wrapper was correctly constructed\n            focused = this.editor.isFocused();\n            this.textarea.val(this.editor.getSession().getValue()); // Copy data back\n            this.editor.destroy();\n            $(this.editNode).remove();\n            if (focused) {\n                this.textarea.focus();\n                this.textarea[0].selectionStart = this.textarea[0].value.length;\n            }\n        }\n    };\n\n    AceWrapper.prototype.hasFocus = function() {\n        return this.editor.isFocused();\n    };\n\n    AceWrapper.prototype.findMode = function (language) {\n        var candidate,\n            filename,\n            result,\n            candidates = [], // List of candidate modes.\n            nameMap = {\n                'octave': 'matlab',\n                'nodejs': 'javascript',\n                'c#': 'cs'\n            };\n\n        if (typeof language !== 'string') {\n            return undefined;\n        }\n        if (language.toLowerCase() in nameMap) {\n            language = nameMap[language.toLowerCase()];\n        }\n\n        candidates = [language, language.replace(/\\d+$/, \"\")];\n        for (var i = 0; i < candidates.length; i++) {\n            candidate = candidates[i];\n            filename = \"input.\" + candidate;\n            result = this.modelist.modesByName[candidate] ||\n                this.modelist.modesByName[candidate.toLowerCase()] ||\n                this.modelist.getModeForPath(filename) ||\n                this.modelist.getModeForPath(filename.toLowerCase());\n\n            if (result && result.name !== 'text') {\n                return result;\n            }\n        }\n        return undefined;\n    };\n\n    AceWrapper.prototype.resize = function(w, h) {\n        this.editNode.outerHeight(h);\n        this.editNode.outerWidth(w);\n        this.editor.resize();\n    };\n\n     return {\n        Constructor: AceWrapper\n    };\n});\n"],"file":"ui_ace.min.js"}