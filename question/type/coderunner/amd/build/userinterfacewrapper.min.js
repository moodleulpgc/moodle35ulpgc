define(["jquery"],function(a){function b(b,c,d,e){var f,g=this;this.MIN_WIDTH=400,this.MIN_HEIGHT=100,this.GUTTER=14,this.taId=c,this.loadFailId=c+"_loadfailerr",this.textArea=a(document.getElementById(c)),this.readOnly=this.textArea.prop("readonly"),this.isLoading=!1,this.loadFailed=!1,this.loadFailMessage=d.uiloadfail,this.retries=0,f=parseInt(this.textArea.css("height")),this.wrapperNode=a("<div id='"+this.taId+"_wrapper' class='ui_wrapper'></div>"),this.textArea.after(this.wrapperNode),this.wrapperNode.hide(),this.wrapperNode.css({resize:"vertical",overflow:"hidden",height:f,width:"auto",border:"1px solid darkgrey"}),this.textArea.data("current-ui-wrapper",this),this.uiInstance=null,this.loadUi(b,e),a(document).mousemove(function(){g.checkForResize()}),a(window).resize(function(){g.checkForResize()}),a(document.body).on("keydown",function(a){var b=77;a.keyCode===b&&a.ctrlKey&&a.altKey&&(null!==g.uiInstance||g.loadFailed?g.stop():g.restart())})}function c(a,c,d,e,f){var g;if(a){try{g=window.JSON.parse(e)}catch(h){g={}}return f&&(g.lang=f),new b(a,c,d,g)}return null}return b.prototype.loadUi=function(b,c){var d=this;return this.isLoading?(this.retries+=1,void(this.retries>20?(alert("Failed to load UI component. If this error persists, please report it to the forum on coderunner.org.nz"),this.retries=0,this.loading=0):setTimeout(function(){d.loadUi(b,c)},200))):(this.retries=0,this.params=c,this.stop(),this.uiname=b,void(""===this.uiname||"none"===this.uiname||sessionStorage.getItem("disableUis")?this.uiInstance=null:(this.isLoading=!0,require(["qtype_coderunner/ui_"+this.uiname],function(b){var e,f,g,h,i;h=d.wrapperNode.innerHeight()-d.GUTTER,i=d.wrapperNode.innerWidth(),f=new b.Constructor(d.taId,i,h,c),f.failed()?(d.wrapperNode.hide(),f.destroy(),d.uiInstance=null,d.loadFailed=!0,d.textArea.addClass("uiloadfailed"),g='<div id="'+d.loadFailId+'"class="uiloadfailed">'+d.loadFailMessage+"</div>",a(g).insertBefore(d.textArea)):(e=f.getMinSize(),d.wrapperNode.css({minWidth:e.minWidth,minHeight:e.minHeight+d.GUTTER}),d.hLast=0,d.wLast=0,d.wrapperNode.append(f.getElement()),d.textArea.hide(),d.wrapperNode.show(),d.uiInstance=f,d.loadFailed=!1,d.checkForResize()),d.isLoading=!1}))))},b.prototype.stop=function(){null!==this.uiInstance&&(this.textArea.show(),this.uiInstance.hasFocus()&&(this.textArea.focus(),this.textArea[0].selectionStart=this.textArea[0].value.length),this.uiInstance.destroy(),this.uiInstance=null,this.wrapperNode.hide()),this.loadFailed=!1,this.textArea.removeClass("uiloadfailed"),a(document.getElementById(this.loadFailId)).remove()},b.prototype.restart=function(){null===this.uiInstance&&this.loadUi(this.uiname,this.params)},b.prototype.checkForResize=function(){var b,c,d,e,f,g,h=25;this.uiInstance&&(b=this.wrapperNode.innerHeight(),d=this.wrapperNode.innerWidth(),f=this.wrapperNode.offset().left,g=a(window).innerWidth()-f-h,c=Math.max(this.MIN_HEIGHT,b)-this.GUTTER,e=Math.max(this.MIN_WIDTH,Math.min(g,d)),(c!==this.hLast||e!==this.wLast&&this.uiInstance)&&(this.uiInstance.resize(e,c),this.hLast=c,this.wLast=e))},{newUiWrapper:c,InterfaceWrapper:b}});