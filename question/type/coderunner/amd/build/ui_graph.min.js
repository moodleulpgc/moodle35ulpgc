define ("qtype_coderunner/ui_graph",["jquery","qtype_coderunner/graphutil","qtype_coderunner/graphelements"],function(a,b,c){function d(b,c,d,e){this.HANDLE_SIZE=10;this.parent=b;this.canvas=a(document.createElement("canvas"));this.canvas.attr({id:c,class:"coderunner_graphcanvas",tabindex:1});this.canvas.css({"background-color":"white"});this.canvas.on("mousedown",function(a){return b.mousedown(a)});this.canvas.on("mouseup",function(a){return b.mouseup(a)});this.canvas.on("dblclick",function(a){return b.dblclick(a)});this.canvas.on("keydown",function(a){return b.keydown(a)});this.canvas.on("mousemove",function(a){return b.mousemove(a)});this.canvas.on("keypress",function(a){return b.keypress(a)});this.resize=function(a,b){this.canvas.attr("width",a);this.canvas.attr("height",b)};this.resize(d,e)}function e(b,e,f,g){var h=this;this.SNAP_TO_PADDING=6;this.DUPLICATE_LINK_OFFSET=16;this.HIT_TARGET_PADDING=6;this.DEFAULT_NODE_RADIUS=26;this.DEFAULT_FONT_SIZE=20;this.canvasId="graphcanvas_"+b;this.textArea=a(document.getElementById(b));this.helpText="";this.readOnly=this.textArea.prop("readonly");this.templateParams=g;this.graphCanvas=new d(this,this.canvasId,e,f);this.caretVisible=!0;this.caretTimer=0;this.originalClick=null;this.nodes=[];this.links=[];this.helpBox=new c.HelpBox(this,0,0);this.helpBoxHighlighted=!1;this.selectedObject=null;this.currentLink=null;this.movingObject=!1;this.fail=!1;this.failString=null;if("locknodes"in g){g.locknodepositions=g.locknodes}if("lockedges"in g){g.lockedgepositions=g.lockedges}if("helpmenutext"in g){this.helpText=g.helpmenutext}else{require(["core/str"],function(b){var c=b.get_string("graphhelp","qtype_coderunner");a.when(c).done(function(a){h.helpText=a})})}this.reload();if(!this.fail){this.draw()}}e.prototype.failed=function(){return this.fail};e.prototype.failMessage=function(){return this.failString};e.prototype.getElement=function(){return this.getCanvas()};e.prototype.hasFocus=function(){return document.activeElement==this.getCanvas()};e.prototype.getCanvas=function(){var a=this.graphCanvas.canvas[0];return a};e.prototype.nodeRadius=function(){return this.templateParams.noderadius?this.templateParams.noderadius:this.DEFAULT_NODE_RADIUS};e.prototype.fontSize=function(){return this.templateParams.fontsize?this.templateParams.fontsize:this.DEFAULT_FONT_SIZE};e.prototype.isFsm=function(){return this.templateParams.isfsm!==void 0?this.templateParams.isfsm:!0};e.prototype.arrowIfReqd=function(a,c,d,e){if(this.templateParams.isdirected===void 0||this.templateParams.isdirected){b.drawArrow(a,c,d,e)}};e.prototype.sync=function(){};e.prototype.keypress=function(a){var c=b.crossBrowserKey(a);if(this.readOnly){return}if(32<=c&&126>=c&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&null!==this.selectedObject&&this.canEditText()){this.selectedObject.text+=String.fromCharCode(c);this.resetCaret();this.draw();return!1}else if(8===c||32===c||9===c){return!1}};e.prototype.mousedown=function(a){var d=b.crossBrowserRelativeMousePos(a);if(this.readOnly){return}this.selectedObject=this.selectObject(d.x,d.y);this.movingObject=!1;this.movingGraph=!1;this.originalClick=d;if(null!==this.selectedObject){if(a.shiftKey&&this.selectedObject instanceof c.Node){if(!this.templateParams.lockedgeset){this.currentLink=new c.SelfLink(this,this.selectedObject,d)}}else if(a.altKey&&this.selectedObject instanceof c.Node){if(!this.templateParams.locknodepositions){this.movingGraph=!0;this.movingNodes=this.selectedObject.traverseGraph(this.links,[]);for(var e=0;e<this.movingNodes.length;e++){this.movingNodes[e].setMouseStart(d.x,d.y)}}}else if(!(this.templateParams.locknodepositions&&this.selectedObject instanceof c.Node)&&!(this.templateParams.lockedgepositions&&this.selectedObject instanceof c.Link)){this.movingObject=!0;if(this.selectedObject.setMouseStart){this.selectedObject.setMouseStart(d.x,d.y)}}this.resetCaret()}else if(a.shiftKey&&this.isFsm()){this.currentLink=new c.TemporaryLink(this,d,d)}this.draw();if(this.hasFocus()){return!1}else{this.resetCaret();return!0}};e.prototype.canEditText=function(){return"text"in this.selectedObject&&(this.selectedObject instanceof c.Node&&!this.templateParams.locknodelabels||this.selectedObject instanceof c.Link&&!this.templateParams.lockedgelabels)};e.prototype.keydown=function(a){var c=b.crossBrowserKey(a),d,e=!1;if(this.readOnly){return}if(8===c){if(null!==this.selectedObject&&this.canEditText()){this.selectedObject.text=this.selectedObject.text.substr(0,this.selectedObject.text.length-1);this.resetCaret();this.draw()}return!1}else if(46===c&&null!==this.selectedObject){for(d=0;d<this.nodes.length;d++){if(this.nodes[d]===this.selectedObject&&!this.templateParams.locknodeset){this.nodes.splice(d--,1);e=!0}}for(d=0;d<this.links.length;d++){if(this.links[d]===this.selectedObject&&!this.templateParams.lockedgeset||e&&(this.links[d].node===this.selectedObject||this.links[d].nodeA===this.selectedObject||this.links[d].nodeB===this.selectedObject)){this.links.splice(d--,1)}}this.selectedObject=null;this.draw()}else if(13===c){if(null!==this.selectedObject){this.selectedObject=null;this.draw()}}};e.prototype.dblclick=function(a){var d=b.crossBrowserRelativeMousePos(a);if(this.readOnly||this.templateParams.locknodeset){return}this.selectedObject=this.selectObject(d.x,d.y);if(null===this.selectedObject){this.selectedObject=new c.Node(this,d.x,d.y);this.nodes.push(this.selectedObject);this.resetCaret();this.draw()}else{if(this.selectedObject instanceof c.Node&&this.isFsm()){this.selectedObject.isAcceptState=!this.selectedObject.isAcceptState;this.draw()}}};e.prototype.resize=function(a,b){this.graphCanvas.resize(a,b);this.draw()};e.prototype.mousemove=function(a){var d=b.crossBrowserRelativeMousePos(a),e,f=this.helpBox.containsPoint(d.x,d.y);if(this.readOnly){return}if(f!=this.helpBoxHighlighted){this.helpBoxHighlighted=f;this.draw()}if(null!==this.currentLink){var g=this.selectObject(d.x,d.y);if(!(g instanceof c.Node)){g=null}if(null===this.selectedObject){if(null!==g){this.currentLink=new c.StartLink(this,g,this.originalClick)}else{this.currentLink=new c.TemporaryLink(this,this.originalClick,d)}}else{if(g===this.selectedObject){this.currentLink=new c.SelfLink(this,this.selectedObject,d)}else if(null!==g){this.currentLink=new c.Link(this,this.selectedObject,g)}else{e=this.selectedObject.closestPointOnCircle(d.x,d.y);this.currentLink=new c.TemporaryLink(this,e,d)}}this.draw()}if(this.movingGraph){for(var h=this.movingNodes,j=0;j<h.length;j++){h[j].trackMouse(d.x,d.y);this.snapNode(h[j])}this.draw()}else if(this.movingObject){this.selectedObject.setAnchorPoint(d.x,d.y);if(this.selectedObject instanceof c.Node){this.snapNode(this.selectedObject)}this.draw()}};e.prototype.mouseup=function(){if(this.readOnly){return}this.movingObject=!1;this.movingGraph=!1;if(null!==this.currentLink){if(!(this.currentLink instanceof c.TemporaryLink)){this.selectedObject=this.currentLink;this.addLink(this.currentLink);this.resetCaret()}this.currentLink=null;this.draw()}};e.prototype.selectObject=function(a,b){var c;if(this.helpBox.containsPoint(a,b)&&this.selectedObject!=this.helpBox){return this.helpBox}for(c=0;c<this.nodes.length;c++){if(this.nodes[c].containsPoint(a,b)){return this.nodes[c]}}for(c=0;c<this.links.length;c++){if(this.links[c].containsPoint(a,b)){return this.links[c]}}return null};e.prototype.snapNode=function(a){for(var b=0;b<this.nodes.length;b++){if(this.nodes[b]===a){continue}if(Math.abs(a.x-this.nodes[b].x)<this.SNAP_TO_PADDING){a.x=this.nodes[b].x}if(Math.abs(a.y-this.nodes[b].y)<this.SNAP_TO_PADDING){a.y=this.nodes[b].y}}};e.prototype.addLink=function(a){for(var b=null,c=0,d;c<this.links.length;c++){d=this.links[c];if(d.nodeA===a.nodeA&&d.nodeB===a.nodeB){if(null===b||d.perpendicularPart>b){b=d.perpendicularPart}}if(d.nodeA===a.nodeB&&d.nodeB===a.nodeA){if(null===b||-d.perpendicularPart>b){b=-d.perpendicularPart}}}if(null!==b){a.perpendicularPart=b+this.DUPLICATE_LINK_OFFSET}this.links.push(a)};e.prototype.reload=function(){var b=a(this.textArea).val();if(b){try{var d=JSON.parse(b),e;for(e=0;e<d.nodes.length;e++){var f=d.nodes[e],g=d.nodeGeometry[e],h=new c.Node(this,g[0],g[1]);h.isAcceptState=f[1];h.text=f[0].toString();this.nodes.push(h)}for(e=0;e<d.edges.length;e++){var j=d.edges[e],k=d.edgeGeometry[e],l=null;if(j[0]===j[1]){l=new c.SelfLink(this,this.nodes[j[0]]);l.anchorAngle=k.anchorAngle;l.text=j[2].toString()}else if(-1===j[0]){l=new c.StartLink(this,this.nodes[j[1]]);l.deltaX=k.deltaX;l.deltaY=k.deltaY}else{l=new c.Link(this,this.nodes[j[0]],this.nodes[j[1]]);l.parallelPart=k.parallelPart;l.perpendicularPart=k.perpendicularPart;l.text=j[2].toString();l.lineAngleAdjust=k.lineAngleAdjust}if(null!==l){this.links.push(l)}}}catch(a){this.fail=!0;this.failString="graph_ui_invalidserialisation"}}};e.prototype.save=function(){var a={edgeGeometry:[],nodeGeometry:[],nodes:[],edges:[]},b;if(!JSON||""===this.textArea.val().trim()&&0===this.nodes.length){return}for(b=0;b<this.nodes.length;b++){var d=this.nodes[b],e=[d.text,d.isAcceptState],f=[d.x,d.y];a.nodeGeometry.push(f);a.nodes.push(e)}for(b=0;b<this.links.length;b++){var g=this.links[b],h=null,j=null;if(g instanceof c.SelfLink){j={anchorAngle:g.anchorAngle};h=[this.nodes.indexOf(g.node),this.nodes.indexOf(g.node),g.text]}else if(g instanceof c.StartLink){j={deltaX:g.deltaX,deltaY:g.deltaY};h=[-1,this.nodes.indexOf(g.node),""]}else if(g instanceof c.Link){j={lineAngleAdjust:g.lineAngleAdjust,parallelPart:g.parallelPart,perpendicularPart:g.perpendicularPart};h=[this.nodes.indexOf(g.nodeA),this.nodes.indexOf(g.nodeB),g.text]}if(null!==h&&null!==j){a.edges.push(h);a.edgeGeometry.push(j)}}this.textArea.val(JSON.stringify(a))};e.prototype.destroy=function(){clearInterval(this.caretTimer);this.graphCanvas.canvas.off();this.graphCanvas.canvas.remove()};e.prototype.resetCaret=function(){var a=this;clearInterval(this.caretTimer);this.caretTimer=setInterval(function(){a.caretVisible=!a.caretVisible;a.draw()},500);this.caretVisible=!0};e.prototype.draw=function(){var a=this.getCanvas(),b=a.getContext("2d"),c;b.clearRect(0,0,this.getCanvas().width,this.getCanvas().height);b.save();b.translate(.5,.5);this.helpBox.draw(b,this.selectedObject==this.helpBox,this.helpBoxHighlighted);if(this.selectedObject!=this.helpBox){for(c=0;c<this.nodes.length;c++){b.lineWidth=1;b.fillStyle=b.strokeStyle=this.nodes[c]===this.selectedObject?"blue":"black";this.nodes[c].draw(b)}for(c=0;c<this.links.length;c++){b.lineWidth=1;b.fillStyle=b.strokeStyle=this.links[c]===this.selectedObject?"blue":"black";this.links[c].draw(b)}if(null!==this.currentLink){b.lineWidth=1;b.fillStyle=b.strokeStyle="black";this.currentLink.draw(b)}}b.restore();this.save()};e.prototype.drawText=function(a,d,e,f,g){var h=this.getCanvas().getContext("2d"),c=b.convertLatexShortcuts(a),i,j;h.font=this.fontSize()+"px Arial";i=h.measureText(c).width;d-=i/2;if(null!==f){var k=Math.cos(f),l=Math.sin(f),m=i/2*(0<k?1:-1),n=10*(0<l?1:-1),o=l*Math.pow(Math.abs(l),40)*m-k*Math.pow(Math.abs(k),10)*n;d+=m-l*o;e+=n+k*o}if("advancedFillText"in h){h.advancedFillText(c,a,d+i/2,e,f)}else{d=Math.round(d);e=Math.round(e);j=Math.round(this.fontSize()/3);h.fillText(c,d,e+j);if(g==this.selectedObject&&this.caretVisible&&this.hasFocus()&&document.hasFocus()){d+=i;j=Math.round(this.fontSize()/2);h.beginPath();h.moveTo(d,e-j);h.lineTo(d,e+j);h.stroke()}}};return{Constructor:e}});
//# sourceMappingURL=ui_graph.min.js.map
