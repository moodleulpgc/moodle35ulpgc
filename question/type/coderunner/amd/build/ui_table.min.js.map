{"version":3,"sources":["../src/ui_table.js"],"names":["define","$","TableUi","textareaId","width","height","templateParams","textArea","document","getElementById","readOnly","prop","tableDiv","table_num_columns","table_num_rows","fail","failString","lockedCells","table_locked_cells","hasHeader","hasOwnProperty","hasRowLabels","numDataColumns","totNumColumns","columnWidths","computeColumnWidths","reload","prototype","defaultWidth","Math","trunc","table_column_width_percents","Array","fill","i","push","isLockedCell","row","col","length","getElement","failed","failMessage","sync","serialisation","empty","tableRows","find","each","rowValues","cellVal","val","JSON","stringify","tableRow","iRow","preload","html","widthIndex","table_row_labels","iCol","tableHeadSection","colIndex","table_column_headers","preloadJson","divHtml","parse","error","num_rows_required","max","table_dynamic_rows","addButtons","deleteButton","t","append","click","numRows","lastRow","remove","addButton","newRow","clone","after","prev","resize","hasFocus","focused","activeElement","destroy","Constructor"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more util.details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Implementation of the table_ui user interface plugin. For overall details\n * of the UI plugin architecture, see userinterfacewrapper.js.\n *\n * This plugin replaces the usual textarea answer element with a div\n * containing an HTML table. The number of columns, and\n * the initial number of rows are specified by required template parameters\n * table_num_columns and table_num_rows respectively.\n * Optional additional template parameters are:\n *   1. table_column_headers: a list of strings that can be used to provide a\n *      fixed header row at the top.\n *   2. table_row_labels: a list of strings that can be used to provide a\n *      fixed row label column at the left.\n *   3. table_dynamic_rows, which, if true, allows the user to add rows.\n *   4. table_locked_cells: a list of [row, column] pairs, being the coordinates\n *      of table cells that cannot be changed by the user. row and column numbers\n *      are zero origin and do not include the header row or the row labels.\n *   5. table_column_width_percents: a list of the percentages of the width occupied\n *      by each column. This list must include a value for the row labels, if present.\n *\n * The serialisation of the table, which is what is essentially copied back\n * into the textarea for submissions as the answer, is a JSON array. Each\n * element in the array is itself an array containing the values of one row\n * of the table. Empty cells are empty strings. The table header row and row\n * label columns are not provided in the serialisation.\n *\n * To preload the table with data, simply set the answer_preload of the question\n * to a json array of row values (each itself an array). If the number of rows\n * in the preload exceeds the number set by table_num_rows, extra rows are\n * added. If the number is less than table_num_rows, or if there is no\n * answer preload, undefined rows are simply left blank.\n *\n * As a special case of the serialisation, if all cells in the serialisation\n * are empty strings, the serialisation is itself the empty string.\n *\n * @package    qtype\n * @subpackage coderunner\n * @copyright  Richard Lobb, 2018, The University of Canterbury\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery'], function($) {\n\n    function TableUi(textareaId, width, height, templateParams) {\n        this.textArea = $(document.getElementById(textareaId));\n        this.readOnly = this.textArea.prop('readonly');\n        this.tableDiv = null;\n        this.templateParams = templateParams;\n        if (!templateParams.table_num_columns ||\n            !templateParams.table_num_rows) {\n            this.fail = true;\n            this.failString = 'table_ui_missingparams';\n            return;  // We're dead, fred.\n        }\n\n        this.fail = false;\n        this.lockedCells = templateParams.table_locked_cells || [];\n        this.hasHeader = templateParams.hasOwnProperty('table_column_headers');\n        this.hasRowLabels = templateParams.hasOwnProperty('table_row_labels');\n        this.numDataColumns = templateParams.table_num_columns;\n        this.totNumColumns = this.numDataColumns + (this.hasRowLabels ? 1 : 0);\n        this.columnWidths = this.computeColumnWidths();\n        this.reload();\n    }\n\n    // Return an array of the percentage widths required for each of the\n    // totNumColumns columns.\n    TableUi.prototype.computeColumnWidths = function() {\n        var defaultWidth = Math.trunc(100 / this.totNumColumns),\n            columnWidths = [];\n        if (this.templateParams.table_column_width_percents) {\n            return this.templateParams.table_column_width_percents;\n        } else if (Array.prototype.fill) { // Anything except bloody IE.\n            return new Array(this.totNumColumns).fill(defaultWidth);\n        } else { // IE. What else?\n            for (var i = 0; i < this.totNumColumns; i++) {\n                columnWidths.push(defaultWidth);\n            }\n            return columnWidths;\n        }\n    };\n\n    // Return True if the cell at the given row and column is locked.\n    // The given row and column numbers exclude column headers and row labels.\n    TableUi.prototype.isLockedCell = function(row, col) {\n        for (var i = 0; i < this.lockedCells.length; i++) {\n            if (this.lockedCells[i][0] == row && this.lockedCells[i][1] == col) {\n                return true;\n            }\n        }\n        return false;\n    };\n\n    TableUi.prototype.getElement = function() {\n        return this.tableDiv;\n    };\n\n    TableUi.prototype.failed = function() {\n        return this.fail;\n    };\n\n    TableUi.prototype.failMessage = function() {\n        return this.failString;\n    };\n\n    // Copy the serialised version of the Table UI area to the TextArea.\n    TableUi.prototype.sync = function() {\n        var\n            serialisation = [],\n            empty = true,\n            tableRows = $(this.tableDiv).find('table tbody tr');\n\n        tableRows.each(function () {\n            var rowValues = [];\n            $(this).find('textarea').each(function () {\n                var cellVal = $(this).val();\n                rowValues.push(cellVal);\n                if (cellVal) {\n                    empty = false;\n                }\n            });\n            serialisation.push(rowValues);\n        });\n\n        if (empty) {\n            this.textArea.val('');\n        } else {\n            this.textArea.val(JSON.stringify(serialisation));\n        }\n    };\n\n    // Return the HTML for row number iRow.\n    TableUi.prototype.tableRow = function(iRow, preload) {\n        var html = '<tr>', widthIndex = 0, width;\n\n        // Insert the row label if required.\n        if (this.hasRowLabels) {\n            width = this.columnWidths[0];\n            widthIndex = 1;\n            html += \"<th style='padding-top:8px;text-align:center;width:\" + width + \"%' scope='row'>\";\n            if (iRow < this.templateParams.table_row_labels.length) {\n                html += this.templateParams.table_row_labels[iRow];\n            }\n            html += \"</th>\";\n        }\n\n        for (var iCol = 0; iCol < this.numDataColumns; iCol++) {\n            width = this.columnWidths[widthIndex++];\n            html += \"<td style='padding:2px;margin:0,width:\" + width + \"'%>\";\n            html += '<textarea rows=\"2\" style=\"width:100%;padding:0;resize:vertical;font-family: monospace\"';\n            if (this.isLockedCell(iRow, iCol)) {\n                html += ' disabled>';\n            } else {\n                html += '>';\n            }\n            if (iRow < preload.length) {\n                html += preload[iRow][iCol];\n            }\n            html += '</textarea>';\n            html += \"</td>\";\n        }\n        html += '</tr>';\n        return html;\n    };\n\n    // Return the HTML for the table's head section.\n    TableUi.prototype.tableHeadSection = function() {\n        var html = \"<thead>\\n\",\n            colIndex = 0;  // Column index including row label if present.\n\n        if (this.hasHeader) {\n            html += \"<tr>\";\n\n            if (this.hasRowLabels) {\n                html += \"<th style='width:\" + this.columnWidths[0] + \"%'></th>\";\n                colIndex += 1;\n            }\n\n            for(var iCol = 0; iCol < this.numDataColumns; iCol++) {\n                html += \"<th style='width:\" + this.columnWidths[colIndex] + \"%'>\";\n                if (iCol < this.templateParams.table_column_headers.length) {\n                    html += this.templateParams.table_column_headers[iCol];\n                }\n                colIndex++;\n                html += \"</th>\";\n            }\n            html += \"</tr>\\n\";\n        }\n        html += \"</thead>\\n\";\n        return html;\n    };\n\n    // Build the HTML table, filling it with the data from the serialisation\n    // currently in the textarea (if there is any).\n    TableUi.prototype.reload = function() {\n        var\n            preloadJson = $(this.textArea).val(), // JSON-encoded table values.\n            preload = [],\n            divHtml = \"<div style='height:fit-content' class='qtype-coderunner-table-outer-div'>\\n\" +\n                      \"<table class='table table-bordered qtype-coderunner_table'>\\n\";\n\n        if (preloadJson) {\n            try {\n                preload = JSON.parse(preloadJson);\n            } catch(error)  {\n                this.fail = true;\n                this.failString = 'table_ui_invalidjson';\n                return;\n            }\n        }\n\n        try {\n            // Build the table head section.\n            divHtml += this.tableHeadSection();\n\n            // Build the table body. Each table cell has a textarea inside it,\n            // except for row labels (if present).\n            divHtml += \"<tbody>\\n\";\n            var num_rows_required = Math.max(this.templateParams.table_num_rows, preload.length);\n            for (var iRow = 0; iRow < num_rows_required; iRow++) {\n                divHtml += this.tableRow(iRow, preload);\n            }\n\n            divHtml += '</tbody>\\n</table>\\n</div>';\n            this.tableDiv = $(divHtml);\n            if (this.templateParams.table_dynamic_rows) {\n                this.addButtons();\n            }\n        } catch (error) {\n            this.fail = true;\n            this.failString = 'table_ui_invalidserialisation';\n        }\n    };\n\n    // Add 'Add row' and 'Delete row' buttons at the end of the table.\n    TableUi.prototype.addButtons = function() {\n        var deleteButtonHtml = '<button type=\"button\"' +\n                'style=\"float:right;margin-right:6px\" disabled>Delete row</button>',\n            deleteButton = $(deleteButtonHtml),\n            t = this;\n        this.tableDiv.append(deleteButton);\n        deleteButton.click(function() {\n            var numRows = t.tableDiv.find('table tbody tr').length,\n                lastRow = t.tableDiv.find('tr:last');\n            if (numRows > t.templateParams.table_num_rows) {\n                lastRow.remove();\n            }\n            lastRow = t.tableDiv.find('tr:last'); // New last row.\n            if (numRows == t.templateParams.table_num_rows + 1) {\n                $(this).prop('disabled', true);\n            }\n        });\n\n        var addButtonHtml = '<button type=\"button\"' +\n                'style=\"float:right;margin-right:6px\">Add row</button>',\n            addButton = $(addButtonHtml);\n        t.tableDiv.append(addButton);\n        addButton.click(function() {\n            var lastRow, newRow;\n            lastRow = t.tableDiv.find('table tbody tr:last');\n            newRow = lastRow.clone();  // Copy the last row of the table.\n            newRow.find('textarea').each(function() {  // Clear all td elements in it.\n                $(this).val('');\n            });\n            lastRow.after(newRow);\n            $(this).prev().prop('disabled', false);\n        });\n    };\n\n    TableUi.prototype.resize = function() {}; // Nothing to see here. Move along please.\n\n    TableUi.prototype.hasFocus = function() {\n        var focused = false;\n        $(this.tableDiv).find('textarea').each(function() {\n            if (this === document.activeElement) {\n                focused = true;\n            }\n        });\n        return focused;\n    };\n\n    // Destroy the HTML UI and serialise the result into the original text area.\n    TableUi.prototype.destroy = function() {\n        this.sync();\n        $(this.tableDiv).remove();\n        this.tableDiv = null;\n    };\n\n    return {\n        Constructor: TableUi\n    };\n});\n"],"file":"ui_table.min.js"}