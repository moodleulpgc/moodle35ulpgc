define(["core/ajax","core/event"],function(Ajax,CustomEvents){"use strict";function StackInput(validationDiv,prefix,qaid,name,input){function cancelTypingDelay(){delayTimeoutHandle&&clearTimeout(delayTimeoutHandle),delayTimeoutHandle=null}function valueChanging(){cancelTypingDelay(),showWaiting(),delayTimeoutHandle=setTimeout(valueChanged,TYPING_DELAY),setTimeout(function(){checkNoChange()},0)}function checkNoChange(){getInputValue()===lastValidatedValue&&(cancelTypingDelay(),validationDiv.classList.remove("waiting"))}function valueChanged(){cancelTypingDelay(),showValidationResults()||validateInput()}function validateInput(){Ajax.call([{methodname:"qtype_stack_validate_input",args:{qaid:qaid,name:name,input:getInputValue()},done:function(a){validationReceived(a)},fail:function(a){showValidationFailure(a)}}]),showLoading()}function getInputValue(){return input.getValue()}function validationReceived(a){return"invalid"===a.status?void showValidationFailure(a):(validationResults[a.input]=a,void showValidationResults())}function extractScripts(a,b){for(var c,d=/<script[^>]*>([\s\S]*?)<\/script>/g;null!==(c=d.exec(a));)b.push(c[1]);return a.replace(d,"")}function showValidationResults(){var val=getInputValue();if(!validationResults[val])return showWaiting(),!1;var results=validationResults[val];lastValidatedValue=val;var scriptCommands=[];validationDiv.innerHTML=extractScripts(results.message,scriptCommands);for(var i=0;i<scriptCommands.length;i++)eval(scriptCommands[i]);return removeAllClasses(),results.message||validationDiv.classList.add("empty"),CustomEvents.notifyFilterContentUpdated(validationDiv),!0}function showValidationFailure(a){lastValidatedValue="",validationDiv.innerHTML=a.message,removeAllClasses(),validationDiv.classList.add("error"),CustomEvents.notifyFilterContentUpdated(validationDiv)}function showLoading(){removeAllClasses(),validationDiv.classList.add("loading")}function showWaiting(){removeAllClasses(),validationDiv.classList.add("waiting")}function removeAllClasses(){validationDiv.classList.remove("empty"),validationDiv.classList.remove("error"),validationDiv.classList.remove("loading"),validationDiv.classList.remove("waiting")}var TYPING_DELAY=1e3,delayTimeoutHandle=null,validationResults={},lastValidatedValue=getInputValue();input.addEventHandlers(valueChanging)}function StackSimpleInput(a){this.addEventHandlers=function(b){a.addEventListener("input",b)},this.getValue=function(){return a.value.replace(/^\s+|\s+$/g,"")}}function StackTextareaInput(a){this.addEventHandlers=function(b){a.addEventListener("input",b)},this.getValue=function(){var b=a.value.replace(/^\s+|\s+$/g,"");return b.split(/\s*[\r\n]\s*/).join("<br>")}}function StackRadioInput(a){this.addEventHandlers=function(b){a.addEventListener("input",b)},this.getValue=function(){var b=a.querySelector(":checked");return b?b.value:""}}function StackCheckboxInput(a){this.addEventHandlers=function(b){a.addEventListener("input",b)},this.getValue=function(){for(var b=a.querySelectorAll(":checked"),c=[],d=0;d<b.length;d++)c[d]=b[d].value;return c.length>0?c.join(","):""}}function initInputs(a,b,c,d){for(var e=document.getElementById(a),f=!0,g=0;g<d.length;g++)f=initInput(e,b,c,d[g])&&f;f&&(e.classList.contains("dfexplicitvaildate")||e.classList.contains("dfcbmexplicitvaildate"))&&e.querySelector(".im-controls input.submit").remove()}function initInput(a,b,c,d){var e=document.getElementById(b+d+"_val");if(!e)return!1;var f=getInputTypeHandler(a,b,d);return!!f&&(new StackInput(e,b,c,d,f),!0)}function getInputTypeHandler(a,b,c){var d=a.querySelector('[name="'+b+c+'"]');if(d)return"TEXTAREA"===d.nodeName?new StackTextareaInput(d):"radio"===d.type?new StackRadioInput(d.closest(".answer")):new StackSimpleInput(d);if(d=a.querySelector('[name="'+b+c+'_1"]'),d&&"checkbox"===d.type)return new StackCheckboxInput(d.closest(".answer"));var e=document.getElementById(b+c+"_container");return e?new StackMatrixInput(b+c,e):null}var StackMatrixInput=function(a,b){var c=0,d=0;b.querySelectorAll("input[type=text]").forEach(function(b){if(b.name.slice(0,a.length+5)===a+"_sub_"){var e=b.name.substring(a.length+5).split("_");d=Math.max(d,parseInt(e[0],10)+1),c=Math.max(c,parseInt(e[1],10)+1)}}),StackMatrixInput.prototype.addEventHandlers=function(a){b.addEventListener("input",a)},StackMatrixInput.prototype.getValue=function(){for(var e=new Array(d),f=0;f<d;f++)e[f]=new Array(c);return b.querySelectorAll("input[type=text]").forEach(function(b){if(b.name.slice(0,a.length+5)===a+"_sub_"){var c=b.name.substring(a.length+5).split("_");e[c[0]][c[1]]=b.value.replace(/^\s+|\s+$/g,"")}}),"matrix(["+e.join("],[")+"])"}};return{initInputs:initInputs}});