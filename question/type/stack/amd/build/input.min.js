define(["jquery","core/ajax","core/event"],function($,ajax,coreevent){"use strict";var StackInput=function(a,b,c,d){this.input=c,this.validationDiv=d,this.name=a,this.qaid=b,this.delayTimeoutHandle=null,this.input.addEventHanders(this),this.lastValidatedValue=this.getIntputValue(),this.validationResults={}};StackInput.prototype.TYPINGDELAY=1e3,StackInput.prototype.cancelTypingDelay=function(){this.delayTimeoutHandle&&clearTimeout(this.delayTimeoutHandle),this.delayTimeoutHandle=null},StackInput.prototype.valueChanging=function(){this.cancelTypingDelay();var a=this;this.showWaiting(),this.delayTimeoutHandle=setTimeout(function(){a.valueChanged()},this.TYPINGDELAY),setTimeout(function(){a.checkNoChange()},0)},StackInput.prototype.checkNoChange=function(){this.getIntputValue()===this.lastValidatedValue&&(this.cancelTypingDelay(),this.validationDiv.removeClass("waiting"))},StackInput.prototype.valueChanged=function(){this.cancelTypingDelay(),this.showValidationResults()||this.validateInput()},StackInput.prototype.validateInput=function(){var a=this;ajax.call([{methodname:"qtype_stack_validate_input",args:{qaid:this.qaid,name:this.name,input:this.getIntputValue()},done:function(b){a.validationReceived(b)},fail:function(b){a.showValidationFailure(b)}}]),this.showLoading()},StackInput.prototype.getIntputValue=function(){return this.input.getValue()},StackInput.prototype.validationReceived=function(a){return"invalid"===a.status?void this.showValidationFailure(a):(this.validationResults[a.input]=a,void this.showValidationResults())},StackInput.prototype.extractScripts=function(a,b){for(var c,d=/<script[^>]*>([\s\S]*?)<\/script>/g;null!==(c=d.exec(a));)b.push(c[1]);return a.replace(d,"")},StackInput.prototype.showValidationResults=function(){var val=this.getIntputValue();if(!this.validationResults[val])return this.showWaiting(),!1;var results=this.validationResults[val];this.lastValidatedValue=val;var scriptcommands=[],html=this.extractScripts(results.message,scriptcommands);this.validationDiv.html(html);for(var i=0;i<scriptcommands.length;i++)eval(scriptcommands[i]);return this.removeAllClasses(),results.message||this.validationDiv.addClass("empty"),coreevent.notifyFilterContentUpdated(this.validationDiv[0]),!0},StackInput.prototype.showValidationFailure=function(a){this.lastValidatedValue="",this.validationDiv.html(a.message),this.removeAllClasses(),this.validationDiv.addClass("error")},StackInput.prototype.showLoading=function(){this.removeAllClasses(),this.validationDiv.addClass("loading")},StackInput.prototype.showWaiting=function(){this.removeAllClasses(),this.validationDiv.addClass("waiting")},StackInput.prototype.removeAllClasses=function(){this.validationDiv.removeClass("empty"),this.validationDiv.removeClass("error"),this.validationDiv.removeClass("loading"),this.validationDiv.removeClass("waiting")};var StackSimpleInput=function(a){this.input=a};StackSimpleInput.prototype.addEventHanders=function(a){this.input.on("input",null,null,a.valueChanging.bind(a))},StackSimpleInput.prototype.getValue=function(){return this.input.val().replace(/^\s+|\s+$/g,"")};var StackTextareaInput=function(a){this.textarea=a};StackTextareaInput.prototype.addEventHanders=function(a){this.textarea.on("input",null,null,a.valueChanging.bind(a))},StackTextareaInput.prototype.getValue=function(){var a=this.textarea.val().replace(/^\s+|\s+$/g,"");return a.split(/\s*[\r\n]\s*/).join("<br>")};var StackMatrixInput=function(a,b){this.container=b,this.idPrefix=a;var c=0,d=0;this.container.find("input[type=text]").each(function(b,e){var f=$(e).attr("name");if(f.slice(0,a.length+5)===a+"_sub_"){var g=f.substring(a.length+5).split("_");d=Math.max(d,parseInt(g[0],10)+1),c=Math.max(c,parseInt(g[1],10)+1)}}),this.numcol=c,this.numrow=d};StackMatrixInput.prototype.addEventHanders=function(a){this.container.delegate("input","input[type=text]",null,a.valueChanging.bind(a))},StackMatrixInput.prototype.getValue=function(){for(var a=this.numcol,b=this.numrow,c=this.idPrefix,d=new Array(b),e=0;e<b;e++)d[e]=new Array(a);return this.container.find("input[type=text]").each(function(a,b){var e=$(b).attr("name");if(e.slice(0,c.length+5)===c+"_sub_"){var f=e.substring(c.length+5).split("_");d[f[0]][f[1]]=$(b).val().replace(/^\s+|\s+$/g,"")}}),"matrix(["+d.join("],[")+"])"};var t={initInputs:function(a,b,c){for(var d=0;d<a.length;d++)t.initInput(a[d],b,c)},initInput:function(a,b,c){var d=$(document.getElementById(c+a+"_val"));if(!d)return!1;var e=$(document.getElementById(c+a));if(e.length)return"TEXTAREA"===e[0].nodeName?new StackInput(a,b,new StackTextareaInput(e),d):new StackInput(a,b,new StackSimpleInput(e),d),!0;var f=$(document.getElementById(c+a+"_container"));return!!f.length&&(new StackInput(a,b,new StackMatrixInput(c+a,f),d),!0)}};return t});