define(["jquery","core/str"],function(a,b){var c={};return c.plugin="qtype_essayautograde",c.itemtype="",c.itemmatch="",c.editortype="",c.editormaxtries=50,c.editorinterval=100,c.init=function(a,b,d){var e="";switch(b){case"chars":e=".";break;case"words":e="\\w+";break;case"sentences":e="[^\\.]+[\\.]";break;case"paragraphs":e="[^\\r\\n]+[\\r\\n]*"}c.itemtype=b,c.itemmatch=new RegExp(e,"g"),c.editortype=d,a?c.setup_response_heights():c.setup_itemcounts()},c.setup_response_heights=function(){a("textarea.qtype_essay_response").each(function(){a(this).height(1),a(this).height(this.scrollHeight)})},c.setup_itemcounts=function(){a(".qtype_essay_response").each(function(){var b=c.get_itemcount_id(this),d=a.Deferred();c.check_editor(this,d),a.when(d).done(a.proxy(function(){c.create_itemcount(this,b),c.setup_itemcount(this,b)},this,b))})},c.check_editor=function(b,d){var e="";switch(c.editortype){case"atto":e="[contenteditable=true]";break;case"tinymce":e="iframe"}if(""==e)d.resolve();else var f=setInterval(function(){a(b).find(e).length&&(clearInterval(f),d.resolve())},c.editorinterval)},c.create_itemcount=function(a,b){if(null===document.getElementById(b)){var c=document.createElement("P");c.setAttribute("id",b),c.setAttribute("class","itemcount"),a.parentNode.insertBefore(c,a.nextSibling)}},c.setup_itemcount=function(b,d){var e=c.get_editable_element(b);e&&(a(e).keyup(function(){c.show_itemcount(this,d)}),c.show_itemcount(e,d))},c.get_editable_element=function(b){if("TEXTAREA"==a(b).prop("tagName"))return b;var c=a(b).find("[contenteditable=true]");if(c.length)return c.get(0);var d=b.getElementsByTagName("IFRAME");if(d.length){d=d[0];var e=d.contentWindow||d.contentDocument;if(e.document&&(e=e.document),e.body&&e.body.isContentEditable)return e.body}var c=a(b).find("textarea");return c.length?c.get(0):null},c.get_textarea=function(b){return"TEXTAREA"==a(b).prop("tagName")?b:a(b).find("textarea").get(0)},c.get_textarea_name=function(b){var d=c.get_textarea(b);return a(d).attr("name")},c.get_itemcount_id=function(a){var b=c.get_textarea_name(a);return"id_"+b+"_itemcount"},c.escape=function(a){var b=new RegExp("(:|\\.|\\[|\\]|,|=|@)","g");return"#"+a.replace(b,"\\$1")},c.show_itemcount=function(d,e){if("TEXTAREA"==a(d).prop("tagName"))var f=a(d).val().match(c.itemmatch);else var f=a(d).text().match(c.itemmatch);f=f?f.length:0,b.get_strings([{key:c.itemtype,component:c.plugin}]).done(function(b){a(c.escape(e)).text(b[0]+": "+f)})},c});