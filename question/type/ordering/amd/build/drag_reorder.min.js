define(["jquery",require.specified("core/dragdrop")?"core/dragdrop":"qtype_ordering/dragdrop",require.specified("core/key_codes")?"core/key_codes":"qtype_ordering/key_codes"],function(a,b,c){return function(d){var e=null,f=null,g=null,h=null,i=null,j=function(c,h){e={time:(new Date).getTime(),x:h.x,y:h.y},g=a(c.currentTarget).closest(d.itemInPage),"undefined"!=typeof d.reorderStart&&d.reorderStart(g.closest(d.list),g),f=r(),i=a(d.proxyHtml.replace("%%ITEM_HTML%%",g.html()).replace("%%ITEM_CLASS_NAME%%",g.attr("class"))),a(document.body).append(i),i.css("position","absolute"),i.css(g.offset()),i.width(g.outerWidth()),i.height(g.outerHeight()),g.addClass(d.itemMovingClass),b.start(c,i,k,m)},k=function(){var b=g.closest(d.list),c=null,e=null;b.find(d.item).each(function(b,d){var f=q(d,i);(null===c||f<e)&&(c=a(d),e=f)}),c[0]!==g[0]&&(p(i)<p(c)?g.insertBefore(c):g.insertAfter(c))},l=function(a,b){var c=[];return a.split(",").forEach(function(a){b.split(",").forEach(function(b){c.push(a.trim()+" "+b.trim())})}),c.join(", ")},m=function(a,b){"undefined"!=typeof d.reorderEnd&&d.reorderEnd(g.closest(d.list),g);var c=r();s(f,c)?(new Date).getTime()-e.time<500&&Math.abs(e.x-a)<10&&Math.abs(e.y-b)<10&&g[0].focus():d.reorderDone(g.closest(d.list),g,c),i.remove(),i=null,g.removeClass(d.itemMovingClass),g=null,e=null},n=function(a,b){var d;switch(a.keyCode){case c.space:case c.arrowRight:case c.arrowDown:a.preventDefault(),a.stopPropagation(),d=document.getElementById(b.attr("id"));var e=d.nextSibling;null!==e&&e.parentNode.insertBefore(e,e.previousSibling);break;case c.arrowLeft:case c.arrowUp:a.preventDefault(),a.stopPropagation(),d=document.getElementById(b.attr("id"));var f=d.previousSibling;null!==f&&f.parentNode.insertBefore(f,f.nextSibling.nextSibling)}},o=function(a){return a.offset().left+a.outerWidth()/2},p=function(a){return a.offset().top+a.outerHeight()/2},q=function(b,c){var d=a(b),e=a(c),f=o(d)-o(e),g=p(d)-p(e);return Math.sqrt(f*f+g*g)},r=function(){return(g||h).closest(d.list).find(d.item).map(function(a,b){return d.idGetter(b)}).get()},s=function(a,b){return a.length===b.length&&a.every(function(a,c){return a===b[c]})};d.itemInPage=l(d.list,d.item),a(d.list).on("mousedown touchstart",d.item,function(a){var c=b.prepare(a);c.start&&j(a,c)}),a(d.list).on("keydown",d.item,function(b){h=a(b.currentTarget).closest(d.itemInPage),f=r(),n(b,h);var c=r();s(f,c)||d.reorderDone(h.closest(d.list),h,c)}),a(d.itemInPage).attr("tabindex","0")}});